<html>

<head>

  <script>
    function getTransformMatrix(trnsOprtns, baseMatrix) {
      let matrix = baseMatrix || [
        [1, 0, 0],
        [0, 1, 0],
        [0, 0, 1]
      ];
      for (let i = 0; i < trnsOprtns.length; i++) {
        let arrOpr = trnsOprtns[i].split(/[(),]/g).filter(v => {
          return v !== ""
        });
        switch (arrOpr[0]) {
          case "rotate":
            matrix = multiply(matrix, [
              [Math.cos(degToRad(arrOpr[1])), (-1) * Math.sin(degToRad(arrOpr[1])), 0],
              [Math.sin(degToRad(arrOpr[1])), Math.cos(degToRad(arrOpr[1])), 0],
              [0, 0, 1]
            ]);
            break;
          case "scale":
            matrix = multiply(matrix, [
              [arrOpr[1], 0, 0],
              [0, arrOpr[1], 0],
              [0, 0, 1]
            ]);
            break;
          case "scaleX":
            matrix = multiply(matrix, [
              [arrOpr[1], 0, 0],
              [0, 1, 0],
              [0, 0, 1]
            ]);
            break;
          case "scaleY":
            matrix = multiply(matrix, [
              [1, 0, 0],
              [0, arrOpr[1], 0],
              [0, 0, 1]
            ]);
            break;
          case "translate":
            matrix = multiply(matrix, [
              [1, 0, arrOpr[1]],
              [0, 1, arrOpr[2]],
              [0, 0, 1]
            ]);
            break;
          case "translateX":
            matrix = multiply(matrix, [
              [1, 0, arrOpr[1]],
              [0, 1, 0],
              [0, 0, 1]
            ]);
            break;
          case "translateY":
            matrix = multiply(matrix, [
              [1, 0, 0],
              [0, 1, arrOpr[1]],
              [0, 0, 1]
            ]);
            break;
          case "skew":
            var angle =
              matrix = multiply(matrix, [
                [1, Math.tan(degToRad(arrOpr[1])), 0],
                [Math.tan(degToRad(arrOpr[2])), 1, 0],
                [0, 0, 1]
              ]);
            break;
          case "skewX":
            matrix = multiply(matrix, [
              [1, Math.tan(degToRad(arrOpr[1])), 0],
              [0, 1, 0],
              [0, 0, 1]
            ]);
            break;
          case "skewY":
            matrix = multiply(matrix, [
              [1, 0, 0],
              [Math.tan(degToRad(arrOpr[1])), 1, 0],
              [0, 0, 1]
            ]);
            break;
        }
      }
      return `matrix(${[matrix[0][0],matrix[1][0], matrix[0][1], matrix[1][1], matrix[0][2], matrix[1][2]].join()})`;
    }

    function convertTransformMatrix(strMatrix) {
      let arr = strMatrix.replace(/[matrix\(\) ]/g, "").split(",");
      if (!strMatrix || arr.length < 6) {
        return null;
      }
      let arrMatrix = [
        [arr[0], arr[2], arr[4]],
        [arr[1], arr[3], arr[5]],
        [0, 0, 1]
      ];
      return arrMatrix;
    }

    function getElementTransformation(element) {
      if (element) {
        let computedStyle = window.getComputedStyle(element);
        return convertTransformMatrix(computedStyle.transform);
      }
      return null;

    }

    function setElementTransformation(element, strTrns) {
      if (element) {
        element.style["-webkit-transform"] = strTrns;
        element.style["-moz-transform"] = strTrns;
        element.style["-ms-transform"] = strTrns;
        element.style["-o-transform"] = strTrns;
        element.style["transform"] = strTrns;
      }
    }

    function degToRad(x) {
      return Number(x) * Math.PI / 180;
    }

    function multiply(a, b) {
      let aNumRows = a.length;
      let aNumCols = a[0].length;
      let bNumRows = b.length;
      let bNumCols = b[0].length;
      let m = new Array(aNumRows);
      for (let r = 0; r < aNumRows; ++r) {
        m[r] = new Array(bNumCols);
        for (let c = 0; c < bNumCols; ++c) {
          m[r][c] = 0;
          for (let i = 0; i < aNumCols; ++i) {
            m[r][c] += a[r][i] * b[i][c];
          }
        }
      }
      return m;
    }

    /*requestAnimationFrame SHIM for all browser*/
    (function () {
      var lastTime = 0;
      var vendors = ['webkit', 'moz'];
      for (var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
        window.requestAnimationFrame = window[vendors[x] + 'RequestAnimationFrame'];
        window.cancelAnimationFrame =
          window[vendors[x] + 'CancelAnimationFrame'] || window[vendors[x] + 'CancelRequestAnimationFrame'];
      }

      if (!window.requestAnimationFrame)
        window.requestAnimationFrame = function (callback, element) {
          var currTime = new Date().getTime();
          var timeToCall = Math.max(0, 16 - (currTime - lastTime));
          var id = window.setTimeout(function () {
              callback(currTime + timeToCall);
            },
            timeToCall);
          lastTime = currTime + timeToCall;
          return id;
        };

      if (!window.cancelAnimationFrame)
        window.cancelAnimationFrame = function (id) {
          clearTimeout(id);
        };
    }());
  </script>
</head>

<body>

  <script>
    //let trnsOprns = ["skew(10,10)", "rotate(-45)"]; //, "translateX(230)", "scale(1.5)"];
    let screenHeight = window.innerHeight;
    let screenWidth = window.innerWidth;
    let bouncePlaneY = screenHeight - 50;
    let strHtml =
      `<div style='border-top:1px solid black;width:${screenWidth}px;position: absolute; top: ${bouncePlaneY};'><div>`;
    document.querySelector("body").innerHTML = strHtml;
    for (var i = 0; i < 1; i++) {
      let top = Math.round(Math.random() * 1000) % (bouncePlaneY - 100);
      let left = Math.round(Math.random() * 1000) % (screenWidth - 20);
      //let height = Math.round(Math.random() * 500);
      //height = height < 100 ? height + 100 : height;

      height = 500;
      strHtml =
        `<div id="myDiv${i}" style='
      width: ${50}px;
      height: ${height}px;
      background: ${getRandomColor()};
      margin-left: ${left}px;
      text-align: center;
      
      position:absolute; 
      top:${bouncePlaneY - height};
      '>${i}</div>`;

      strHtml +=
        `<div style='border-top:1px solid black;width:${screenWidth}px;position: absolute; top: ${bouncePlaneY-height};'><div>`

      document.querySelector("body").insertAdjacentHTML("beforeend", strHtml);

      var myDiv = document.getElementById(`myDiv${i}`);

      let options = {
        elasticity: 0.9,
        baseWidth: 50,
        baseHeight: height,
        preTransform: [],
        postTansform: []
      };

      createElastic(myDiv, options, () => {
        console.log("end")
      });
    }



    /*
     *  createBounce Function for bouncy effect. 
     *  @param {Object} element - The target element where bounce apply.
     *  @param {Number} options.dropHeight - height where it starts to fallen.
     *  @param {Number} options.slope - Is the angle in which object moves.
     *  @param {Array} options.preTransform - is array of transformation apply before animation.
     *  @param {Array} options.postTransform - is array of transformation apply after animation.
     *  @param {Function} callBack - Function call after completing animation. 
     */
    function createElastic(element, options, callBack) {
      let distTravelled = 1000;
      let frequency = 1;
      let period = 1 / frequency;
      let time = 0;
      let amp = 50;

      let baseTransformMatrix = getElementTransformation(element);

      let timenow = window.performance.now ?
        (performance.now() + performance.timing.navigationStart) : Date.now();
      let intervalId = requestAnimationFrame((timestamp) => {
        let starttime = window.performance.now ?
          (performance.now() + performance.timing.navigationStart) : Date.now();
        moveIt(starttime - timenow);
      });

      function moveIt(intervalMS) {
        let omega = (2 * Math.PI * frequency);
        

        time += intervalMS;
        let displacement = amp * Math.cos(omega * (time / 1000));
        let modHeight = options.baseHeight - displacement;
        let scale = options.baseHeight / modHeight;
        //console.log("displacement",displacement,"scale", scale, "modHeight",modHeight , Math.abs(amp - displacement));
        
        
        if(Math.abs(Math.round(displacement)) < 2) {
          amp*= 0.9;
          console.log("displacement",displacement, "amp", amp);
        }
        if(Math.round(amp) === 0) {
          return; 
        }

        let trnsOprns = [`scaleY(${scale})`,`translateY(${-(displacement/2)})`];
        setElementTransformation(element, getTransformMatrix(trnsOprns, baseTransformMatrix));

        let timenow = window.performance.now ?
          (performance.now() + performance.timing.navigationStart) : Date.now();
        intervarId = requestAnimationFrame((timestamp) => {
          let starttime = window.performance.now ?
            (performance.now() + performance.timing.navigationStart) : Date.now();
          moveIt(starttime - timenow);
        });

      } /*End of moveIt()*/

    }

    function getRandomColor() {
      var letters = '0123456789ABCDEF';
      var color = '#';
      for (var i = 0; i < 6; i++) {
        color += letters[Math.floor(Math.random() * 16)];
      }
      return color;
    }
  </script>
</body>
</head>